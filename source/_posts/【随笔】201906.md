---
title: 【随笔】201906
date: 2019-06-06 16:55:44
tags:
- 随笔
- 201906
---

## 2019-6-6

```
14台集群环境：
调度器
Director1（LVS1 + Keepalived1）
Director2（LVS2 + Keepalived2）
Web服务器
RealServer1
RealServer2
RealServer3
消息服务器
ActiveMQ1
ActiveMQ2
缓存服务器
Redis1
Redis2
数据库
MySQL1
MySQL2
分布式存储
FastDFS1
FastDFS2
预览服务器
Office1

1. redis在服务器断电时出现pid文件残留，系统重启后服务无法再次启动，需要清除pid文件才能启动成功
2. ActiveMQ依赖MySQL，但两个服务又不在同一个机器，如何确保服务正常启动？
3. LVS+Keepalived两台Director网卡都有VIP存在，关闭防火墙后正常

我来贴上解决方法吧，出现这问题的场景是在阿里VPS云服务器网络环境中，因为路由交换层禁用了ARP的广播限制，造成KEEPALIVE主备协议无法通过广播的方式进行通信，造成主备两台服务器都强占HAVIP地址，出现同时两台服务器都有VIP地址的情况出现，必须通过配置来指定IP的两台服务器间进行通讯（阿里说明文档中解释只能支持两台使用同一个HAVIP地址），基于以下方法可以的情况下，多备方式用同样的方式也应该可行，有需要的兄弟可以测试下多IP备的方式（正常情况需要主备一对主备就够了）。
在网卡配置后面需要加上以下配置：
unicast_src_ip  192.168.1.21	##（本地IP地址）
unicast_peer {
		192.168.1.22	##（对端IP地址）此地址一定不能忘记
}

之前我们用keepalived做集群时一般使用它构建服务器主从，也就是只有一个vip，并且这个vip只是在主节点上，当主节点宕机时，vip漂移到从节点上，从而实现高可用。但随着业务的发展，单个节点随之成为业务的性能瓶颈，及时我们使用的负载均衡再强大，服务器配置再高，也不可能单节点抗住所有流量。而通过这种方案，在keepalived的主从基础上扩展一下，通过配置多个vip，每个keepalived节点互为主从，正常情况下保证所有服务器都能拥有一个vip，然后通过dns负载均衡技术，将业务流量转发到每个vip。从而在一定程度上避免了单服务器的性能瓶颈。
```

## 2019-6-4

```
给进入 eth0 的包打包 mark 的标记，当数据包是发给 VIP:80 并且 MAC 不是其它 LVS 服务器的话。才做个 mark，这样才会对指定的 fwmark 进行 loadbalance 放入到 LVS 中处理。只要数据包是从任意其它的 MAC 地址（非 LVS 的转发）会被发往 VIP:port，会不在进行 loadbalanced 而是直接转给后面监听的 demon 程序进行应用的处理。实际就是使用 iptables 来对进入的流量设置 MARK。然后配置 keepalived 只处理有 MARK 过的流量。不在使用以前绑定的 VIP 和端口

# iptables  -t mangle -I PREROUTING -d $VIP -p tcp -m tcp --dport $VPORT -m mac ! --mac-source $MAC_Director2 -j MARK --set-mark 0x3
$VIP 为VIP地址
$VPORT 为服务端口
$MAC_Director2 是备机的MAC (keepalived 之间互相监听的那块网卡)

# iptables  -t mangle -I PREROUTING -d 192.168.23.253 -p tcp -m tcp --dport 80 -m mac ! --mac-source 08:00:27:46:c7:d4 -j MARK --set-mark 0x3
# iptables  -t mangle -I PREROUTING -d 192.168.23.253 -p tcp -m tcp --dport 80 -m mac ! --mac-source 08:00:27:9e:ef:a0 -j MARK --set-mark 0x4

ipvs的防火墙打标，实现基于防火墙的负载均衡集群
# virtual_server fwmark int

http://www.linuxyw.com/linux/fuzaijunheng/20130429/146.html
```

